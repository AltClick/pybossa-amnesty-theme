{% extends "/base.html" %}
{% set active_page = "projects" %}
{% set active_project  = project.short_name %}
{% import "projects/_helpers.html" as helper %}

{% block content %}
{% from "_formhelpers.html" import render_field %}
{{ helper.render_loading(loading_text) }}
<div class="row">
    <div class="span3">
        {{ helper.render_project_local_nav(project, 'tasks', current_user, pro_features)}}
    </div>

    <div class="span9">
        <h1><strong>{{project.name}}</strong>: {{_('Import tasks')}}</h1>
        <h2>{{_('From an Amazon S3 bucket')}}</h2>
        <div id="grant">
            {{ _('Grant Crowdcrafting access to your S3 buckets to select one...') }}
            <br>
            <a href="{{ url_for('amazon.login', next=url_for(target, short_name=project.short_name, type='s3')) }}" class="btn btn-secondary">{{ _('Log in AWS') }}</a>
        </div>
        <br>
        <div id="buckets-container" class="row">
            <ul id="buckets"></ul>
        </div>
        <br>
        <p>
            {{ _('For more information, please look at') }}
            <a href="http://docs.pybossa.com/en/latest/user/overview.html" target="_blank">{{ _('the documentation') }}.</a>
        </p>
        {% if form %}
        <form class="form-group" method="post" action="{{ url_for(target, short_name=project.short_name) }}">
            <fieldset>
                {{ form.hidden_tag() }}

            </fieldset>
            <p id="message" style="display: none;">{{ _('You are about to import') }} <span id="numFiles"></span> {{ _('files') }}.</p>
                <input id="submit" type="submit" value="{{_('Import')}}" class="btn btn-primary" />
                <a href="{{ url_for('project.tasks', short_name=project.short_name) }}" class="btn">{{_('Cancel')}}</a>
        </form>
        {% endif %}
    </div>
</div>

<script type="text/javascript">
    $(function() {
        $.get('/amazon/s3/buckets').done(function(buckets) {
            if (buckets.hasOwnProperty('length') && buckets.length > 0) {
                $('#revoke').show();
                $('#grant').hide();
                $('#buckets-container').prepend('<p>'+"{{ _('Select one of your buckets:') }}"+'</p>');
                buckets.forEach(function(bucket){
                    var bucketElement = $('<li class="col-md-4 col-sm-6 col-xs-12"><h4>'+bucket.title+'</h4><img src="'+bucket.thumbnail_url+'"><p class="small">'+bucket.photos+' {{ _('photos') }}</p><button id="'+bucket.id+'" class="btn btn-default btn-bucket">{{ _('Select') }}</button></li>');
                    $('#buckets').append(bucketElement);
                });
            }
            $(".btn-bucket").each(function(){
                $(this).off('click').on('click', function(evt){
                    evt.preventDefault();
                    document.getElementById('bucket_id').value = $(this).attr('id');
                });
            });
        });
    });
</script>
{% endblock %}
